**《密码学》课程设计实验报告**

实验序号：08　　　　　　　　　　实验项目名称：密码学综合实验

| 学　　号                   | 2016301500327                 | 姓　　名                                   | 肖轩淦 | 专业、班 | 16信安3-4班 |   |   |   |   |   |   |   |   |   |   |   |   |   |   |   |   |   |   |   |
|----------------------------|-------------------------------|--------------------------------------------|--------|----------|-------------|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|
| 实验地点                   | 网安学院A3-1、A3-2实验室      | 指导教师                                   | 王张宜 | 时间     | 2018.12.21  |   |   |   |   |   |   |   |   |   |   |   |   |   |   |   |   |   |   |   |
| 实验目的及要求             |                               |                                            |        |          |             |   |   |   |   |   |   |   |   |   |   |   |   |   |   |   |   |   |   |   |
| 1                          | A开始监听                     |                                            |        |          |             |   |   |   |   |   |   |   |   |   |   |   |   |   |   |   |   |   |   |   |
| 2                          |                               | B对A发起连接                               |        |          |             |   |   |   |   |   |   |   |   |   |   |   |   |   |   |   |   |   |   |   |
| 3                          |                               | B生成sm4会话密钥，使用A的公钥加密，发送给A |        |          |             |   |   |   |   |   |   |   |   |   |   |   |   |   |   |   |   |   |   |   |
| 4                          | A使用私钥解密sm4会话密钥      |                                            |        |          |             |   |   |   |   |   |   |   |   |   |   |   |   |   |   |   |   |   |   |   |
| 5                          |                               | B使用sm4会话密钥加密文字并添加校验进行传输 |        |          |             |   |   |   |   |   |   |   |   |   |   |   |   |   |   |   |   |   |   |   |
| 6                          | A接收密文，进行解密并对比hash |                                            |        |          |             |   |   |   |   |   |   |   |   |   |   |   |   |   |   |   |   |   |   |   |
| 7                          |                               | B使用sm4会话密钥加密文件并添加校验进行传输 |        |          |             |   |   |   |   |   |   |   |   |   |   |   |   |   |   |   |   |   |   |   |
| 8                          | A收到密文，进行解密并对比hash |                                            |        |          |             |   |   |   |   |   |   |   |   |   |   |   |   |   |   |   |   |   |   |   |
| 六、教师评语 签名： 日期： | 成绩                          |                                            |        |          |             |   |   |   |   |   |   |   |   |   |   |   |   |   |   |   |   |   |   |   |

>   教学目的：

1.  熟悉适合密码应用的领域及应用方法；

2.  掌握一种密码应用技术。

实验要求：

1.  掌握对称算法的实现；

2.  掌握非对称算法的实现；

3.  实现下列密码学的一种（或多种）应用：

-   计算机文件加密

-   通信加密

-   认证

-   签名

-   密钥管理

1.  掌握加密、签名、认证、密钥管理等技术的综合运用。

二、实验设备（环境）及要求

Windows 10 64位

Python 3.6.1

GUI库：wxpython

三、实验内容与步骤

作品名称：基于通信加密的文字文件传输系统

简介：本软件是基于通信加密的文字文件传输软件，实现了接收端、发送端二合一，可在网络内(1)实现全双工通信(2)。通信加密使用公开加密算法协商单次会话

![](media/be199f2eacbeb80c5a9c32e824b7fa85.png)

使用的分组密码密钥，使用分组密码进行加密通信，可自定义公开加密算法的相关参数，并设计了一套简单的通信协议及包格式，以校验发送的加密数据的完整性。

注：(1)
可在两台主机都具有公网ip时，或是在同一无NAT端口映射的局域网时进行全双工通信。

(2)若发送端和接收端在同一台主机上工作时，由于端口的唯一性，应用程序与端口绑定，故只能实现半双工通信。

程序运行截图（这是使用单个终端进行发送接收测试）：

**程序使用说明：**

以下为单机情况进行半双工通信为例：

进入到可执行文件的文件夹，

先打开1个客户端（单机情况下不需要更改配置）：

![](media/e1b1b5aac91d2c331285d14315b6b2a0.png)

![](media/16b01cbb1eb30e64732dc5a64b70d8ab.png)

点击监听：

![](media/201c96b21636a755e8e00f2f42823296.png)

若出现以上界面，说明端口监听成功；若提示失败，转至下方可能出现的问题-端口冲突

打开另外一个客户端（单机情况不需要配置）：（左边为新建客户端，右边为已开启监听的客户端）

![](media/c8e6b0d8f4209dddcc78133b3290975d.png)

点击新打开客户端的连接：

![](media/d5bf7a7f0dca09ca6ce50025b0733cf7.png)

![](media/11b95f5370f75f8a55a8432318340f36.png)

此时，已协商好sm4 会话密钥。由于现在是在单机上测试，只能进行半双工通信。

连接方为发送方，监听方为接收方。

发送方在输入栏输入并发送一个字符串

![](media/2d84e24d7b5b11ad52e9c67c855d161e.png)

接下来发送一个文件：选择“…”按钮，选择文件，点击发送。

![](media/315940344f543f791f2653ab7de33d98.png)

![](media/c543ed67092533470688f9975ad46d64.png)

可见接收方收到了文件，文件储存于接收方目录下的recv文件夹内，

![](media/45577446954f3cf656435e3c097b5337.png)

统计信息可在命令行中查看（尽量使用1KB-1MB的文件，避免时间显示不准确）：

![](media/85a272ac63fac4bfabe50ac12128d966.png)

打开文件检查加解密结果

![](media/80aa80a5a81c5a6436c01b7ba82e7c8f.png)

相同！加密传输文件成功。

可能出现的问题：

1、端口被占用

![](media/f465ee17c51ffc4e04f44ca95e7aa17a.png)

通过netstat -ano\|findstr "2333"指令检查是否有程序已经占用了软件所需端口。

程序实现说明：

1.  软件架构

![](media/3f9a78e698ca1ba46f5c5b4705f34337.png)

软件架构及各文件作用说明（从上至下）：

-   Person指的是用户，用户与GUI界面进行交互。

-   GUI模块在./GUI.py中实现，作用是绘制窗口及绑定按钮事件

-   Communication模块是在./communication.py中实现，其是对socket、msgencrypto、keymanager三个模块进行封装，并实现了通信协议的收发控制。

-   Socket模块是在./network.py中实现，其作用是根据上层给定的ip和端口，建立连接或监听端口，并对实现了发送接收文件、发送接收字符串、发送接收bytes的方法，方便上层模块调用。

-   Msgencrypto模块是在crypto/MsgCrypto.py中实现，实现了rsa初始化加解密、sm4初始化及文件字符串的加解密、sm3文件字符串的hash方法，方便上层模块调用。

-   Rsa即rsa加解密模块，在crypto/RSA.py中实现

-   Sm4为sm4加解密模块，在crypto/SM4.py中实现

-   Sm3为sm3 hash模块，在crypto/SM3.py中实现

-   Keymanager为密钥管理模块，作用是对用户的rsa公私钥进行管理，并实现了生成sm4会话密钥的方法。

项目文件夹中其他文件的作用：

-   Keyfile.json 储存RSA512的相关信息

-   Target_config.json 储存接收方的ip、端口

-   Config_util.py 一些配置变量，可以调整其，以使得加解密时能够输出更多的信息

-   Crypto/number_theory.py 一些数论函数的实现，方便RSA调用

-   Recv/ 接收文件文件夹，接收方收到文件后，将储存到这个文件夹下。

二、 通信流程

A、B代表两个客户端，以单工通信为例进行说明。

主要类及其函数说明

对于一些重要的类，及方法进行说明，大部分函数可以通过其函数名大概了解其功能。

1.  GUI.py

绘制窗口及绑定按钮事件

![](media/306709db7ff6bb6ab750c661677bdfc6.png)

二、 communication.py

对socket、msgencrypto、keymanager三个模块进行封装，并实现了通信协议的收发控制。

![](media/16c0bd6826fbda231051739e07fdc93f.png)

三、 network.py

根据上层给定的ip和端口，建立连接或监听端口，并对实现了发送接收文件、发送接收字符串、发送接收bytes的方法，方便上层模块调用。

![](media/597f159f4229f2e9a5292e660881a8be.png)

四、 MsgCrypto.py

![](media/531d88d12bd63a6c86a211be069b9fd5.png)

五、keymanager.py

![](media/ae795ecd731ed885b39809352a835586.png)

六、SM4

![](media/edb14a0c31f89b90fcce18e7f8bec749.png)

七、RSA

![](media/a4d17a4ea004329fce71f78987dc5ccb.png)

![](media/a16bdafa4880c48568d4096121dcfdb5.png)

八、SM3

![](media/8b253e7b835f2ae2663891eae0f1c747.png)

通信协议及通信数据格式

![](media/46f1c4cd2730bd6a51922745569fabf9.png)

Msg_type: 4 字节。目前实现了三种：传输字符串、传输文件、协商sm4密钥

Msg(encry)_size: 4字节，其值为密文长度

Msg_hash: 32字节，为明文的sm3的hash值

Msg_content:
长度由长度字段定义，传输字符串模式下为字符串的密文；传输文件模式下为文件名和文件内容的密文，以\\x00分隔；协商sm4模式下为公钥加密后的sm4密钥。

在Class Communication中实现。

其他

1.  运行速度

由于是python程序，执行速度较c++偏慢，但由于采用了分组密码，速度也还是不错的。

![](media/427cec70a2a3c683e9708f862df4b673.png)

二、 程序占用空间

由于还要包含相应的GUI库及其他库函数，程序显得稍大一些，但也还是可以接受。

![](media/654ff467537e3b0db23b29335b8d5fd0.png)

三、 安全功能

安全功能较为完善，使用了公钥协商会话密钥，既保证了安全性，也提高了加解密速度，使用512位RSA，并带有sm3
hash校验码，保证加密数据的完整性。

生成大整数算法在crypto/number_theory.py中实现，但由于需要时间较长，不便于演示，故没有加入重新生成大整数的按钮功能。

四、 算法扩展性

通过多层的封装，可以十分方便的对使用的加密算法进行替换迭代。在MsgCrypto中，将加密算法均已封装好，添加新的加密算法也十分方便，只需在MsgCrypto中留出接口，并在keymanager中对其密钥有相应的管理即可。

![](media/42d844efc40d8adaf271932ee88f692d.png)

五、 执行速率和数据吞吐量统计

在进行加解密时，都会对文件文字的sm3、sm4运算速度进行统计，但是由于cpu繁忙程度不同，用时也稍有不同。

![](media/427cec70a2a3c683e9708f862df4b673.png)

六、 平台兼容性

支持windows和linux

Linux版本客户端在

![](media/8f671e0097316af9d8f50d5ea46d9f24.png)

![](media/d38160dc171b0088428112af5627cad2.png)

我是在centos中搭好环境编译生成二进制文件，使用pyinstall编译，可以在64位Linux系统上运行。

Linux版本与Windows版本操作方法一致。
